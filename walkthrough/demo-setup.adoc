= Serverless Demo: Setup =
:experimental:
:imagesdir: images
:toc:
:toclevels: 4


== Setup Prerequisites ==

[IMPORTANT]
====
* Before running any script commands, make sure the run the following in the appropriate shell
+
----
source scripts/shell-setup.sh
----
+
* Make sure you have a user1-cloudnativeapps namespace (the install script will run this)
+
----
oc new-project user1-cloudnativeapps
----
====

== Preparing Cluster ==

. To get the cluster ready for the link:demo-walkthrough.adoc[] you will need to run the following script.  Setup can take more than 10 minutes to complete (especially on crc clusters running locally on a laptop)
+
----
$DEMO_HOME/scripts/install-prereq.sh
----
+
. Check that everything is installed correctly:
+
Kafka is installed correctly once you see the following pods
+
----
my-cluster-kafka-0                                    2/2     Running     0          94s
my-cluster-kafka-1                                    2/2     Running     0          94s
my-cluster-kafka-2                                    2/2     Running     0          94s
my-cluster-zookeeper-0                                2/2     Running     0          4m13s
my-cluster-zookeeper-1                                2/2     Running     0          4m13s
my-cluster-zookeeper-2                                2/2     Running     0          4m12s
----
+
. Check the knative-serving project with this command:
+
----
oc get pods -n knative-serving -w
----
+
A successful serverless install will show the following pods in knative-serving namespace:
+
----
NAME                                READY   STATUS    RESTARTS   AGE
activator-dfb5b7b67-hh5kh           1/1     Running   0          79s
autoscaler-85bb4898c5-5sssb         1/1     Running   0          77s
autoscaler-hpa-865b6d49b7-7sqns     1/1     Running   0          78s
controller-65c8dd48d6-5cl9v         1/1     Running   0          73s
networking-istio-7c9fb7dd4c-lsbdm   1/1     Running   0          73s
webhook-95969d4fc-t9d4v             1/1     Running   0          72s
----

== Appendix ==

=== Installing Knative Kafka Eventing ===

NOTE: This is done by default by the install-prereq.sh script, but is outlined here if you'd like to show off operators after the fact.  To have the script skip the installation of this operator then run the install-prereq.sh script with the `--skip-knative-kafka-eventing` flag.

. First subscribe to the operator
+
----
oc apply -f "$DEMO_HOME/install/kafka-eventing/subscription.yaml"
----
+
.. ALTERNATIVELY, this can also be done manually.  In user1-cloudnativeapps go to *Operators > Operator Hub* to find it
+
image:kafka-event-operator.png[]
+
. Then install the operator with the default values (e.g. across whole cluster)
+
. Track installation with this command:
+
----
watch 'oc get csv -n user1-cloudnativeapps -ocustom-columns-file=$DEMO_HOME/install/csv-columns.txt'
----
+
. and wait until you see:
+
----
NAME                                VERSION   PHASE
amqstreams.v1.4.0                   1.4.0     Succeeded
knative-eventing-operator.v0.13.0   0.13.0    Succeeded
knative-kafka-operator.v0.13.2      0.13.2    Succeeded
serverless-operator.v1.6.0          1.6.0     Succeeded
----

=== Monitoring Installation Progress ===

Open a new terminal and start a watch on the command oc get csv -n openshift-operators. For further reference in the setup we will call this terminal as WATCH_WINDOW.

----
watch 'oc get csv -ocustom-columns-file=$DEMO_HOME/install/csv-columns.txt -n openshift-operators' 
----

==== Monitoring Kafka Cluster Installation ====

You can tail the logs of the amqstreams operator's logs to determine why an installation is taking so long:

----
stern -l "name=amq-streams-cluster-operator" -n openshift-operators
----

NOTE: stern is installed in the .devcontainer that is in the root of this repo.  If you open the repository folder in a container (using vscode remote) stern is installed on the container.

=== Missing Operator Catalogs ===

If you cannot find the operators referenced then run the following on your cluster

----
oc apply -f "$DEMO_HOME/install/redhat-operators-csc.yaml" \
  -f "$DEMO_HOME/install/community-operators-csc.yaml"

oc -n openshift-marketplace get csc
----

A successful reconciliation should show an output like:

----
NAME                           STATUS      MESSAGE                                       AGE
community-operators-packages   Succeeded   The object has been successfully reconciled   62s
redhat-operators-packages      Succeeded   The object has been successfully reconciled   62s
----